<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Death2Data — Private Search</title>
<meta name="description" content="Search the web privately. No tracking. No ads. No data harvesting.">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="icon" href="/favicon.ico" sizes="32x32">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#0a0a0a">
<meta property="og:title" content="Death2Data — Private Search">
<meta property="og:description" content="Search the web privately. No tracking. No ads.">
<meta property="og:url" content="https://death2data.com/">
<meta property="og:image" content="https://death2data.com/og-image.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@700&display=swap');

/* === VARIABLES === */
:root {
  --bg: #0a0a0a;
  --surface: #111;
  --border: #1e1e1e;
  --border-hover: #2a3a2a;

  --text: #e0e0e0;
  --text-body: #b0b0b0;
  --text-muted: #666;
  --text-dim: #444;

  --green: #00cc44;
  --green-dim: #004d1a;
  --green-hover: #00e64d;
  --red: #cc0000;

  --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', monospace;

  --pad: 16px;
  --radius: 8px;
  --max-w: 600px;
}

/* === RESET === */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
a { color: inherit; text-decoration: none; }

/* === BASE === */
html, body { height:100%; overflow:hidden; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  -webkit-font-smoothing: antialiased;
}

/* === HEADER === */
.hd {
  display: flex;
  align-items: center;
  padding: 0 var(--pad);
  height: 48px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: 16px;
}
.hd-logo {
  font-family: var(--mono);
  font-weight: 700;
  font-size: 14px;
  color: var(--green);
  letter-spacing: 1px;
  margin-right: auto;
}
.hd a:not(.hd-logo) { color: var(--text-muted); font-size: 13px; }
.hd a:not(.hd-logo):hover { color: var(--text); }
.hd a.active { color: var(--text); }

/* === MAIN === */
.main {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.main.centered { justify-content: center; }

/* === HOME STATE === */
.home {
  text-align: center;
  padding: 0 var(--pad);
  max-width: 440px;
  animation: up .4s ease both;
}
@keyframes up {
  from { opacity:0; transform:translateY(12px); }
  to { opacity:1; transform:translateY(0); }
}
.home-logo {
  font-family: var(--mono);
  font-size: 28px;
  font-weight: 700;
  color: var(--green);
  margin-bottom: 4px;
}
.home-tag {
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 3px;
  margin-bottom: 40px;
}
.home-pitch {
  font-size: 14px;
  color: var(--text-muted);
  line-height: 1.8;
  margin-bottom: 40px;
}
.home-pitch strong { color: var(--text-body); font-weight: 500; }

/* === SEARCH STATE === */
.search-wrap {
  display: none;
  width: 100%;
  flex-direction: column;
  align-items: center;
  animation: up .3s ease both;
}
body.searching .home { display: none; }
body.searching .search-wrap { display: flex; }
body.searching .main { justify-content: flex-start; }

/* Search bar */
.sbar {
  display: flex;
  width: 100%;
  max-width: var(--max-w);
  padding: 12px var(--pad);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}
.sbar input {
  flex: 1;
  height: 48px;
  padding: 0 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-right: none;
  border-radius: var(--radius) 0 0 var(--radius);
  color: var(--text);
  font-family: var(--font);
  font-size: 15px;
  outline: none;
  transition: border-color .2s;
}
.sbar input:focus { border-color: var(--green); }
.sbar input::placeholder { color: var(--text-dim); }
.sbar button {
  height: 48px;
  padding: 0 20px;
  background: var(--green);
  border: 1px solid var(--green);
  border-radius: 0 var(--radius) var(--radius) 0;
  color: #000;
  font-family: var(--font);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: background .2s;
}
.sbar button:hover { background: var(--green-hover); }

/* Home search bar (bigger, centered) */
.home .sbar {
  position: static;
  padding: 0;
  max-width: 100%;
  margin-bottom: 32px;
}

/* Result meta */
.meta {
  width: 100%;
  max-width: var(--max-w);
  padding: 0 var(--pad);
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

/* Results */
.results {
  width: 100%;
  max-width: var(--max-w);
  padding: 0 var(--pad) 80px;
}
.card {
  padding: 16px;
  margin-bottom: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: border-color .15s;
}
.card:hover { border-color: var(--border-hover); }
.card-title {
  display: block;
  color: var(--green);
  font-size: 15px;
  font-weight: 500;
  line-height: 1.4;
  margin-bottom: 4px;
  cursor: pointer;
}
.card-title:hover { text-decoration: underline; color: var(--green-hover); }
.card-url {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 8px;
}
.card-url img { width: 14px; height: 14px; border-radius: 2px; }
.card-snip {
  font-size: 13px;
  color: var(--text-body);
  line-height: 1.6;
}

/* Paywall card */
.paywall {
  padding: 24px 16px;
  margin-bottom: 10px;
  border: 1px dashed var(--green-dim);
  border-radius: var(--radius);
  text-align: center;
}
.paywall-title {
  font-size: 14px;
  color: var(--text);
  margin-bottom: 6px;
}
.paywall-sub {
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 16px;
}
.paywall-btn {
  display: inline-block;
  padding: 12px 32px;
  background: var(--green);
  color: #000;
  font-weight: 600;
  font-size: 14px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: background .2s;
}
.paywall-btn:hover { background: var(--green-hover); }

/* Loading */
.loading {
  text-align: center;
  padding: 40px 0;
  color: var(--text-dim);
  font-size: 13px;
}

/* === FOOTER === */
.ft {
  display: flex;
  align-items: center;
  padding: 0 var(--pad);
  height: 44px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  gap: 10px;
  font-size: 12px;
  background: var(--bg);
}
.ft-dot {
  width: 6px; height: 6px;
  background: var(--green);
  border-radius: 50%;
  flex-shrink: 0;
}
.ft-user {
  color: var(--green);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 160px;
}
.ft-sep { color: var(--border); }
.ft a { color: var(--text-muted); }
.ft a:hover { color: var(--green); }
.ft a.cta { color: var(--green); font-weight: 500; }
.ft input {
  height: 32px;
  padding: 0 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-family: var(--font);
  font-size: 12px;
  outline: none;
  flex: 1;
  min-width: 0;
  max-width: 200px;
}
.ft input:focus { border-color: var(--green); }
.ft button {
  height: 32px;
  padding: 0 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--green);
  font-family: var(--font);
  font-size: 12px;
  cursor: pointer;
}
.ft button:hover { border-color: var(--green); }
.ft .signout { color: var(--text-dim); }
.ft .signout:hover { color: var(--text-muted); }
</style>
</head>
<body>

<!-- HEADER -->
<div class="hd" id="hd">
  <span class="hd-logo">D2D</span>
  <a href="/" class="active">Search</a>
  <a href="/about.html">About</a>
  <a href="/tools.html">Tools</a>
</div>

<!-- MAIN -->
<div class="main centered" id="main">

  <!-- HOME: logo + search -->
  <div class="home" id="home">
    <div class="home-logo">death2data</div>
    <div class="home-tag">PRIVATE SEARCH</div>
    <div class="sbar">
      <input type="text" id="q" placeholder="search anything..." autocomplete="off"
             onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">Search</button>
    </div>
    <div class="home-pitch">
      <strong>No tracking. No ads. No data harvesting.</strong><br>
      3 free searches, then $1/month.
    </div>
  </div>

  <!-- SEARCH RESULTS -->
  <div class="search-wrap" id="search-wrap">
    <div class="sbar">
      <input type="text" id="q2" placeholder="search..." autocomplete="off"
             onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">Search</button>
    </div>
    <div class="meta" id="meta"></div>
    <div class="results" id="results"></div>
  </div>
</div>

<!-- FOOTER -->
<div class="ft" id="ft">
  <a href="/about.html">about</a>
  <span class="ft-sep">·</span>
  <a href="/privacy.html">privacy</a>
</div>

<script>
const S = { token:null, email:null, tier:null, searches:0 };
const API = location.hostname==='localhost' ? '' : 'https://fortune0-com.onrender.com';

/* ── Auth ── */
(function init(){
  const t = sessionStorage.getItem('d2d_token');
  const e = sessionStorage.getItem('d2d_email');
  if (t && e) { S.token = t; S.email = e; showLoggedIn(); }
  else { showLoggedOut(); }

  // Check URL for a query
  const urlQ = new URLSearchParams(location.search).get('q');
  if (urlQ) { setQuery(urlQ); doSearch(); }

  // Verify token is still valid
  if (S.token && S.email) {
    fetch(API+'/api/search?q=ping', {headers:{'Authorization':'Bearer '+S.token}})
      .then(r=>r.json()).then(d=>{
        if (d.authed === false) reauth();
      }).catch(()=>{});
  }
})();

function showLoggedIn() {
  document.getElementById('ft').innerHTML = `
    <span class="ft-dot"></span>
    <span class="ft-user">${S.email}</span>
    <span class="ft-sep">·</span>
    <a href="/tools.html">tools</a>
    <span class="ft-sep">·</span>
    <button class="signout" onclick="logout()">sign out</button>`;
}

function showLoggedOut() {
  document.getElementById('ft').innerHTML = `
    <input type="email" id="email" placeholder="sign in with email"
      onkeydown="if(event.key==='Enter')login()">
    <button onclick="login()">go</button>
    <span class="ft-sep">·</span>
    <a href="/about.html" class="cta">join $1/mo</a>`;
}

async function login() {
  const el = document.getElementById('email');
  const email = el.value.trim().toLowerCase();
  if (!email || !email.includes('@')) return;
  try {
    const r = await fetch(API+'/api/signup', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, source_domain:'death2data.com'})
    });
    const d = await r.json();
    if (d.token) {
      S.token = d.token; S.email = d.email; S.tier = d.tier;
      sessionStorage.setItem('d2d_token', d.token);
      sessionStorage.setItem('d2d_email', d.email);
      showLoggedIn();
    } else if (d.exists) {
      // needs license key — show key input
      el.type = 'password';
      el.placeholder = 'license key';
      el.value = '';
      el.onkeydown = function(e) { if(e.key==='Enter') loginWithKey(email); };
      const btn = el.nextElementSibling;
      btn.onclick = function() { loginWithKey(email); };
    }
  } catch(e) { console.error(e); }
}

async function loginWithKey(email) {
  const el = document.getElementById('email');
  const key = el.value.trim();
  if (!key) return;
  try {
    const r = await fetch(API+'/api/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, key})
    });
    const d = await r.json();
    if (d.token) {
      S.token = d.token; S.email = d.email; S.tier = d.tier;
      sessionStorage.setItem('d2d_token', d.token);
      sessionStorage.setItem('d2d_email', d.email);
      showLoggedIn();
    } else if (d.error) {
      el.value = ''; el.placeholder = d.error;
    }
  } catch(e) { console.error(e); }
}

async function reauth() {
  if (!S.email) return;
  try {
    const r = await fetch(API+'/api/signup', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email: S.email, source_domain:'death2data.com'})
    });
    const d = await r.json();
    if (d.token) {
      S.token = d.token; S.tier = d.tier;
      sessionStorage.setItem('d2d_token', d.token);
    }
  } catch(e) {}
}

function logout() {
  S.token = null; S.email = null; S.tier = null; S.searches = 0;
  sessionStorage.clear();
  location.reload();
}

/* ── Search ── */
function setQuery(q) {
  document.getElementById('q').value = q;
  document.getElementById('q2').value = q;
}

function getQuery() {
  return (document.getElementById('q2').value || document.getElementById('q').value).trim();
}

async function doSearch() {
  const q = getQuery();
  if (!q) return;
  setQuery(q);
  S.searches++;

  // Switch to search mode
  document.body.classList.add('searching');
  document.getElementById('main').classList.remove('centered');
  document.getElementById('meta').textContent = '';
  document.getElementById('results').innerHTML = '<div class="loading">searching...</div>';
  document.getElementById('q2').focus();

  let data;
  try {
    const h = {};
    if (S.token) h['Authorization'] = 'Bearer ' + S.token;
    const r = await fetch(API+'/api/search?q='+encodeURIComponent(q), {headers: h});
    data = await r.json();

    // Dead token? Reauth and retry once
    if (S.token && data.authed === false && S.email && !S._retrying) {
      S._retrying = true;
      await reauth();
      S._retrying = false;
      return doSearch();
    }
  } catch(e) {
    data = { results: [], count: 0, source: 'error' };
  }

  renderResults(data, q);
}

function renderResults(data, q) {
  const el = document.getElementById('results');
  const meta = document.getElementById('meta');
  const results = data.results || [];
  const source = data.source || '';
  const webCount = data.web_results || 0;

  // Meta line
  if (results.length > 0) {
    const parts = [];
    parts.push(`${results.length} result${results.length !== 1 ? 's' : ''}`);
    if (source && source !== 'none') parts.push(source.replace('+', ' + '));
    meta.textContent = parts.join(' · ');
  } else {
    meta.textContent = '';
  }

  // Build cards
  let html = '';

  if (results.length === 0 && !data.web_locked) {
    html = '<div class="loading">no results found</div>';
  }

  results.forEach(r => {
    const url = r.url || '#';
    const domain = url !== '#' ? url.replace(/^https?:\/\//, '').split('/')[0] : '';
    const favicon = domain
      ? `<img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" onerror="this.style.display='none'">`
      : '';

    html += `<div class="card">
      <a class="card-title" href="${url}" target="_blank" rel="noopener">${r.title || ''}</a>
      ${domain ? `<div class="card-url">${favicon}<span>${domain}</span></div>` : ''}
      <div class="card-snip">${r.snippet || r.content || ''}</div>
    </div>`;
  });

  // Soft paywall for non-members
  if (data.web_locked) {
    html += `<div class="paywall">
      <div class="paywall-title">Full web results require a membership</div>
      <div class="paywall-sub">Search the real web privately. No tracking. No ads.</div>
      <a class="paywall-btn" href="https://buy.stripe.com/cNieVd5Vjb6N2ZY6Fq4wM00" target="_blank">
        Get full access — $1/mo
      </a>
    </div>`;
  }

  el.innerHTML = html;
}
</script>
</body>
</html>
