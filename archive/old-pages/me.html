<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Death2Data</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #fff;
            font-family: system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        .card {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .member-status {
            text-align: center;
            padding: 30px 20px;
        }
        .member-status .check {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .member-status h2 {
            color: #0f0;
            margin-bottom: 5px;
        }
        .member-status .email {
            color: #666;
            font-size: 0.9rem;
        }
        .tools-list a {
            display: block;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            text-decoration: none;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }
        .tools-list a:hover { border-color: #0f0; }
        .tools-list .tool-name { font-weight: bold; margin-bottom: 3px; }
        .tools-list .tool-desc { color: #666; font-size: 0.85rem; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            width: 100%;
        }
        button:hover { background: #0c0; }
        button:disabled { background: #333; color: #666; }
        button.secondary {
            background: transparent;
            border: 1px solid #333;
            color: #999;
            font-size: 0.85rem;
            width: auto;
            padding: 8px 16px;
        }
        button.secondary:hover { border-color: #666; color: #fff; }
        .login-box {
            text-align: center;
            padding: 60px 20px;
        }
        .login-box h2 { margin-bottom: 8px; }
        .login-box p { color: #666; margin-bottom: 20px; }
        .login-box input {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
            max-width: 320px;
            margin-bottom: 12px;
            text-align: center;
        }
        .login-box input:focus { outline: none; border-color: #0f0; }
        .error { color: #f44; margin-top: 10px; font-size: 0.9rem; }
        .referral-box {
            background: #000;
            border: 1px solid #333;
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #0f0;
            word-break: break-all;
            text-align: center;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .referral-box:hover { border-color: #0f0; }
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #222;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .join-link { color: #0f0; text-decoration: none; }
    </style>

    <script src="config.js"></script>
    </head>
<body>
    <div class="container">

        <!-- LOGIN -->
        <div id="loginView" class="login-box" style="display:none;">
            <h2>Welcome</h2>
            <p>Enter the email you used to subscribe.</p>
            <input type="email" id="loginEmail" placeholder="you@email.com" autofocus>
            <br>
            <button onclick="login()" id="loginBtn">Check Membership</button>
            <p id="loginError" class="error" style="display:none;"></p>
            <br><br>
            <p style="color:#666;">No account yet? <a href="https://buy.stripe.com/cNieVd5Vjb6N2ZY6Fq4wM00" class="join-link">Join for $1/mo ‚Üí</a></p>
        </div>

        <!-- ACCOUNT -->
        <div id="accountView" style="display:none;">
            <div class="card member-status">
                <div class="check">‚úì</div>
                <h2>You're a member</h2>
                <div class="email" id="memberEmail"></div>
            </div>

            <div class="card">
                <div class="tools-list">
                    <a href="/">
                        <div class="tool-name">üîç Private Search</div>
                        <div class="tool-desc">Unlimited searches, no tracking</div>
                    </a>
                    <a href="/tools">
                        <div class="tool-name">üõ† Tools</div>
                        <div class="tool-desc">QR codes, notebooks, exports</div>
                    </a>
                    <a href="/k/privacy">
                        <div class="tool-name">üí¨ Word of the Day</div>
                        <div class="tool-desc">Today's topic + community perspectives</div>
                    </a>
                </div>
            </div>

            <div class="card">
                <p style="color:#999; font-size:0.85rem; margin-bottom:10px;">Share this link ‚Äî friends who join get you both points.</p>
                <div class="referral-box" id="referralBox" onclick="copyRef()" title="Click to copy">Loading...</div>
                <p id="copyMsg" style="color:#0f0; font-size:0.8rem; text-align:center; display:none;">Copied!</p>
            </div>

            <div class="footer">
                <button class="secondary" onclick="manageBilling()">Manage Billing</button>
                <button class="secondary" onclick="logout()">Logout</button>
            </div>
        </div>

    </div>

    <script>
        function init() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('paid') === 'true') {
                localStorage.setItem('d2d_paid', 'true'); localStorage.setItem('d2d_access', JSON.stringify({tier:100}));
                window.history.replaceState({}, '', '/me.html');
            }

            const email = localStorage.getItem('d2d_email');
            const paid = localStorage.getItem('d2d_paid');

            if (email && paid) {
                showAccount(email);
            } else {
                document.getElementById('loginView').style.display = 'block';
            }
        }

        function showAccount(email) {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('accountView').style.display = 'block';
            document.getElementById('memberEmail').textContent = email;

            let hash = 0;
            for (let i = 0; i < email.length; i++) {
                hash = ((hash << 5) - hash) + email.charCodeAt(i);
                hash |= 0;
            }
            const code = Math.abs(hash).toString(36).substring(0, 8);
            document.getElementById('referralBox').textContent = 'https://death2data.com/r/' + code;
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');

            if (!email) { err.textContent = 'Enter your email'; err.style.display = 'block'; return; }

            btn.textContent = 'Checking...';
            btn.disabled = true;
            err.style.display = 'none';

            try {
                const res = await fetch('https://api.death2data.com/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (data.paying) {
                    localStorage.setItem('d2d_email', email);
                    localStorage.setItem('d2d_paid', 'true');
                    showAccount(email);
                } else {
                    err.textContent = 'No active subscription for this email.';
                    err.style.display = 'block';
                    btn.textContent = 'Check Membership';
                    btn.disabled = false;
                }
            } catch (e) {
                err.textContent = 'Something went wrong. Try again.';
                err.style.display = 'block';
                btn.textContent = 'Check Membership';
                btn.disabled = false;
            }
        }

        function copyRef() {
            const text = document.getElementById('referralBox').textContent;
            navigator.clipboard.writeText(text);
            const msg = document.getElementById('copyMsg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 2000);
        }

        function manageBilling() {
            window.open('mailto:matt@death2data.com?subject=Billing Help', '_blank');
        }

        function logout() {
            localStorage.removeItem('d2d_email');
            localStorage.removeItem('d2d_paid');
            localStorage.removeItem('d2d_tier');
            document.getElementById('accountView').style.display = 'none';
            document.getElementById('loginView').style.display = 'block';
            document.getElementById('loginBtn').textContent = 'Check Membership';
            document.getElementById('loginBtn').disabled = false;
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('loginView').style.display !== 'none') login();
        });

        init();
    </script>
</body>
</html>
