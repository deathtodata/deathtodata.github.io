<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Welcome — Death2Data</title>
<meta name="description" content="Payment successful. Your Death2Data membership is active.">
<link rel="canonical" href="https://death2data.com/success.html">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="icon" href="/favicon.ico" sizes="32x32">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#0a0a0a">

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@700&display=swap');

:root {
  --bg: #0a0a0a;
  --surface: #111111;
  --border: #1e1e1e;
  --green: #00cc44;
  --green-dim: #004d1a;
  --green-hover: #00e64d;
  --white: #e0e0e0;
  --gray: #b0b0b0;
  --muted: #666666;
  --dim: #444444;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--white);
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Header — matches index.html */
.hd {
  display: flex;
  align-items: center;
  padding: 0 16px;
  height: 48px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: 12px;
  background: var(--bg);
}
.hd-logo {
  font-family: var(--mono);
  font-weight: 700;
  font-size: 14px;
  color: var(--green);
  letter-spacing: 1px;
  text-decoration: none;
  margin-right: auto;
}
.hd a:not(.hd-logo) { color: var(--muted); font-size: 13px; text-decoration: none; }
.hd a:not(.hd-logo):hover { color: var(--white); }

/* Main */
.main {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px 16px;
}
.box {
  max-width: 420px;
  text-align: center;
}
.check-big {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: var(--green-dim);
  color: var(--green);
  font-size: 28px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
}
.box h1 {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 8px;
}
.box .sub {
  font-size: 14px;
  color: var(--gray);
  line-height: 1.6;
  margin-bottom: 28px;
}
.box .status-msg {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 24px;
  min-height: 20px;
}
.box .status-msg.ok { color: var(--green); }
.box .status-msg.err { color: #cc4444; }

.btn-primary {
  display: block;
  width: 100%;
  padding: 14px;
  background: var(--green);
  color: var(--bg);
  text-align: center;
  text-decoration: none;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 10px;
  transition: background 0.2s;
}
.btn-primary:hover { background: var(--green-hover); }
.btn-secondary {
  display: block;
  width: 100%;
  padding: 12px;
  background: var(--surface);
  color: var(--gray);
  text-align: center;
  text-decoration: none;
  font-size: 13px;
  border: 1px solid var(--border);
  border-radius: 8px;
  transition: all 0.2s;
}
.btn-secondary:hover { border-color: var(--green); color: var(--white); }

.help {
  margin-top: 28px;
  font-size: 12px;
  color: var(--dim);
}
.help a { color: var(--muted); text-decoration: none; }
.help a:hover { color: var(--white); }

/* Footer */
.ft {
  display: flex;
  align-items: center;
  padding: 0 16px;
  height: 44px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  gap: 10px;
  font-size: 12px;
  background: var(--bg);
}
.ft a { color: var(--muted); text-decoration: none; }
.ft a:hover { color: var(--green); }
.ft-sep { color: var(--border); }
</style>
</head>
<body>

<div class="hd">
  <a href="/" class="hd-logo">D2D</a>
  <a href="/">Search</a>
  <a href="/about.html">About</a>
  <a href="/tools.html">Tools</a>
</div>

<div class="main">
  <div class="box">
    <div class="check-big">&#10003;</div>
    <h1>You're in.</h1>
    <p class="sub">Payment confirmed. Your membership is active. Full search, all tools, no limits.</p>
    <p class="status-msg" id="status">Syncing your account...</p>

    <a href="/" class="btn-primary" id="search-btn">Start Searching &rarr;</a>
    <a href="/tools.html" class="btn-secondary">View All Tools</a>

    <div class="help">
      Questions? <a href="mailto:matt@death2data.com">matt@death2data.com</a>
    </div>
  </div>
</div>

<div class="ft">
  <a href="/about.html">about</a>
  <span class="ft-sep">&middot;</span>
  <a href="/privacy.html">privacy</a>
  <span class="ft-sep">&middot;</span>
  <a href="mailto:matt@death2data.com">support</a>
</div>

<script>
const API = location.hostname === 'localhost' ? '' : 'https://fortune0-com.onrender.com';
const statusEl = document.getElementById('status');

// The whole point of this page: reauth the user so their tier upgrades from free → active
(async function activate() {
  const email = localStorage.getItem('d2d_email');

  if (!email) {
    statusEl.textContent = 'Enter your email on the search page to activate.';
    statusEl.className = 'status-msg';
    return;
  }

  try {
    // Call signup which now auto-logins both free and active users
    const r = await fetch(API + '/api/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, source_domain: 'death2data.com' })
    });
    const d = await r.json();

    if (d.token) {
      localStorage.setItem('d2d_token', d.token);
      localStorage.setItem('d2d_email', d.email || email);

      if (d.tier === 'active') {
        statusEl.textContent = 'Account active — full access enabled.';
        statusEl.className = 'status-msg ok';
      } else {
        // Webhook might not have fired yet — tier still free
        // Try again in a few seconds
        statusEl.textContent = 'Payment received. Activating your account...';
        statusEl.className = 'status-msg';

        // Retry up to 3 times with 3s delay for webhook to process
        for (let i = 0; i < 3; i++) {
          await new Promise(res => setTimeout(res, 3000));
          const r2 = await fetch(API + '/api/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, source_domain: 'death2data.com' })
          });
          const d2 = await r2.json();
          if (d2.token) {
            localStorage.setItem('d2d_token', d2.token);
            if (d2.tier === 'active') {
              statusEl.textContent = 'Account active — full access enabled.';
              statusEl.className = 'status-msg ok';
              return;
            }
          }
        }

        // After retries, still free — webhook might be slow
        statusEl.textContent = 'Payment processing. Your access will activate shortly.';
        statusEl.className = 'status-msg';
      }
    } else {
      statusEl.textContent = 'Signed in as ' + email;
      statusEl.className = 'status-msg';
    }
  } catch(e) {
    // Server might be cold-starting
    statusEl.textContent = 'Server waking up. Your access will sync when you search.';
    statusEl.className = 'status-msg';
  }
})();
</script>

</body>
</html>
