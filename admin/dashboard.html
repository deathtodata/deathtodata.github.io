<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D2D Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: #0a0a0a;
  color: #e0e0e0;
  min-height: 100vh;
}

:root {
  --green: #00cc44;
  --green-dim: rgba(0,204,68,0.1);
  --surface: #111;
  --border: #222;
  --muted: #666;
  --gray: #999;
  --red: #cc0000;
  --yellow: #cc8800;
}

.nav {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: #0a0a0a;
  z-index: 100;
}
.nav .logo { font-weight: 700; color: var(--green); letter-spacing: 1px; font-size: 15px; margin-right: auto; }
.nav a { font-size: 12px; color: var(--muted); text-decoration: none; }
.nav a:hover { color: #e0e0e0; }
.nav .badge {
  font-size: 10px;
  padding: 3px 8px;
  border-radius: 12px;
  background: var(--green-dim);
  color: var(--green);
}

.main { max-width: 900px; margin: 0 auto; padding: 24px 16px 80px; }

h1 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
.subtitle { font-size: 12px; color: var(--muted); margin-bottom: 24px; }

/* Auth gate */
.auth-gate {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 32px;
  max-width: 400px;
  margin: 60px auto;
  text-align: center;
}
.auth-gate h2 { font-size: 18px; margin-bottom: 8px; }
.auth-gate p { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
.auth-gate input {
  width: 100%;
  padding: 14px;
  background: #0a0a0a;
  border: 1px solid var(--border);
  border-radius: 8px;
  color: #e0e0e0;
  font-size: 14px;
  font-family: inherit;
  margin-bottom: 12px;
}
.auth-gate input:focus { outline: none; border-color: var(--green); }
.auth-gate button {
  width: 100%;
  padding: 14px;
  background: var(--green);
  color: #000;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}

/* Stats grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}
.stat-card .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
.stat-card .value { font-size: 28px; font-weight: 700; }
.stat-card .sub { font-size: 11px; color: var(--green); margin-top: 2px; }
.stat-card.green .value { color: var(--green); }

/* Sections */
.section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
}
.section h2 {
  font-size: 13px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 16px;
}

/* Activity chart (simple bar chart) */
.chart { display: flex; align-items: flex-end; gap: 2px; height: 100px; margin-bottom: 8px; }
.chart-bar {
  flex: 1;
  background: var(--green);
  border-radius: 2px 2px 0 0;
  min-height: 2px;
  position: relative;
  cursor: pointer;
}
.chart-bar:hover { background: #00e64d; }
.chart-bar .tooltip {
  display: none;
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: #222;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  white-space: nowrap;
  color: #e0e0e0;
  z-index: 10;
}
.chart-bar:hover .tooltip { display: block; }
.chart-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--muted); }

/* Activity log */
.activity-table { width: 100%; }
.activity-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #1a1a1a;
  font-size: 13px;
}
.activity-row:last-child { border-bottom: none; }
.activity-action {
  display: inline-block;
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
}
.activity-action.search { background: rgba(0,100,255,0.15); color: #4488ff; }
.activity-action.login { background: var(--green-dim); color: var(--green); }
.activity-action.signup { background: rgba(204,136,0,0.15); color: var(--yellow); }
.activity-action.payment { background: rgba(0,204,68,0.15); color: var(--green); }
.activity-action.other { background: rgba(100,100,100,0.15); color: var(--gray); }
.activity-email { color: var(--gray); font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
.activity-detail { color: var(--muted); font-size: 11px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; }
.activity-time { color: var(--muted); font-size: 11px; white-space: nowrap; }

/* User list */
.user-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #1a1a1a;
  font-size: 13px;
}
.user-row:last-child { border-bottom: none; }
.tier-badge {
  display: inline-block;
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
}
.tier-badge.active { background: var(--green-dim); color: var(--green); }
.tier-badge.free { background: rgba(100,100,100,0.15); color: var(--muted); }

/* Refresh */
.refresh-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.refresh-btn {
  padding: 8px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--gray);
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  font-family: inherit;
}
.refresh-btn:hover { border-color: var(--green); color: var(--green); }
.last-updated { font-size: 11px; color: var(--muted); }

/* Loading */
.loading { text-align: center; padding: 40px; color: var(--muted); font-size: 13px; }
.spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
@keyframes spin { to { transform: rotate(360deg); } }

@media (max-width: 600px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .activity-detail { display: none; }
}
</style>
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<meta name="theme-color" content="#0a0a0a">
</head>
<body>

<nav class="nav">
  <span class="logo">D2D</span>
  <a href="/">Search</a>
  <a href="/about.html">About</a>
  <a href="/tools.html">Tools</a>
  <span class="badge" id="statusBadge">connecting...</span>
</nav>

<div class="main">
  <div id="content">
    <div class="loading"><div class="spinner"></div>Loading...</div>
  </div>
</div>

<script>
// ═══════════════════════════════════════
// D2D ADMIN DASHBOARD
// Connects to fortune0 API for live stats
// ═══════════════════════════════════════

const API = 'https://fortune0-com.onrender.com';
let token = localStorage.getItem('d2d_token');
let email = localStorage.getItem('d2d_email');

// ── Auth check ──
async function init() {
  if (!token || !email) {
    // Try auto-login: if already signed in on search page, token works here too
    token = localStorage.getItem('d2d_token');
    email = localStorage.getItem('d2d_email');
    if (!token || !email) {
      showAuth();
      return;
    }
  }

  // Verify token + check admin
  try {
    const r = await fetch(`${API}/api/me`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!r.ok) {
      showAuth('Session expired. Sign in again.');
      return;
    }

    const user = await r.json();

    if (user.error) {
      showAuth('Session expired. Sign in again.');
      return;
    }

    if (!user.is_admin) {
      // Not admin but still signed in — show public stats only
      document.getElementById('statusBadge').textContent = 'member';
      loadPublicDashboard();
      return;
    }

    document.getElementById('statusBadge').textContent = 'admin';
    loadDashboard();
  } catch (e) {
    // Server might be cold-starting
    document.getElementById('statusBadge').textContent = 'server waking...';
    document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div>Waking up server... (free tier takes ~30s)</div>';
    setTimeout(init, 8000);
  }
}

// ── Public dashboard (non-admin view) ──
async function loadPublicDashboard() {
  const content = document.getElementById('content');
  try {
    const pub = await fetch(`${API}/api/public/stats`).then(r => r.json());
    content.innerHTML = `
      <h1>Dashboard</h1>
      <p class="subtitle">Public stats — admin login required for full analytics</p>
      <div class="stats-grid">
        <div class="stat-card green"><div class="label">Active Members</div><div class="value">${pub.customers || 0}</div></div>
        <div class="stat-card"><div class="label">Searches Today</div><div class="value">${pub.searches_today || 0}</div></div>
        <div class="stat-card"><div class="label">Total Searches</div><div class="value">${pub.searches_total || 0}</div></div>
      </div>
      <div class="auth-gate" style="margin-top:24px">
        <h2>Full Analytics</h2>
        <p>Sign in as admin for search charts, user list, revenue data.</p>
        <input type="email" id="authEmail" placeholder="admin email" value="${email || ''}">
        <input type="password" id="authKey" placeholder="admin secret or license key">
        <button onclick="doLogin()">Sign In as Admin</button>
      </div>
    `;
  } catch (e) {
    content.innerHTML = '<div class="loading">Could not load stats. Server may be waking up.</div>';
  }
}

function showAuth(msg) {
  document.getElementById('statusBadge').textContent = 'signed out';
  document.getElementById('content').innerHTML = `
    <div class="auth-gate">
      <h2>Admin Dashboard</h2>
      <p>${msg || 'Sign in with your admin email to view analytics.'}</p>
      <input type="email" id="authEmail" placeholder="admin email" value="${email || ''}">
      <input type="password" id="authKey" placeholder="admin secret or license key">
      <button onclick="doLogin()">Sign In</button>
      <p style="font-size:11px;color:var(--muted);margin-top:12px;">Use your F0_ADMIN_SECRET from Render, or your license key.</p>
    </div>
  `;
}

async function doLogin() {
  const e = document.getElementById('authEmail').value.trim();
  const k = document.getElementById('authKey').value.trim();
  if (!e || !k) return;

  try {
    const r = await fetch(`${API}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: e, key: k })
    });
    const data = await r.json();
    if (data.error) { showAuth(data.error); return; }

    localStorage.setItem('d2d_token', data.token);
    localStorage.setItem('d2d_email', e);
    token = data.token;
    email = e;
    init();
  } catch (err) {
    showAuth('Could not reach server. It may be waking up — try again in 30s.');
  }
}

// ── Load dashboard data ──
async function loadDashboard() {
  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading analytics...</div>';

  const headers = { 'Authorization': 'Bearer ' + token };

  try {
    // Fetch all data in parallel
    const [publicStats, analytics, users] = await Promise.all([
      fetch(`${API}/api/public/stats`).then(r => r.json()).catch(() => null),
      fetch(`${API}/api/analytics`, { headers }).then(r => r.json()).catch(() => null),
      fetch(`${API}/api/admin/users`, { headers }).then(r => r.json()).catch(() => null),
    ]);

    renderDashboard(publicStats, analytics, users);
  } catch (e) {
    content.innerHTML = '<div class="loading" style="color:var(--red)">Failed to load. Server may be waking up.</div>';
  }
}

// ── Render ──
function renderDashboard(pub, analytics, users) {
  const content = document.getElementById('content');

  // Totals
  const customers = pub?.customers || 0;
  const mrr = pub?.mrr || 0;
  const searchesToday = pub?.searches_today || 0;
  const searchesTotal = pub?.searches_total || 0;
  const totalUsers = analytics?.totals?.users || pub?.total_users || 0;
  const activeUsers = analytics?.totals?.active_users || customers;
  const totalSearches = analytics?.totals?.total_searches || searchesTotal;
  const totalPayments = analytics?.totals?.total_payments || 0;

  // Net revenue per search
  const netRevPerSearch = totalSearches > 0 ? ((activeUsers * 0.67) / totalSearches).toFixed(3) : '—';

  // Search chart data (last 30 days)
  const searchDays = analytics?.searches_by_day || [];
  const maxSearches = Math.max(...searchDays.map(d => d.count), 1);

  // Recent activity from analytics
  const signupDays = analytics?.signups_by_day || [];
  const activityDays = analytics?.activity_by_day || [];

  // User list
  const userList = Array.isArray(users) ? users : (users?.users || []);

  content.innerHTML = `
    <h1>Dashboard</h1>
    <p class="subtitle">Live from fortune0 API</p>

    <div class="refresh-bar">
      <span class="last-updated">Updated ${new Date().toLocaleTimeString()}</span>
      <button class="refresh-btn" onclick="loadDashboard()">Refresh</button>
    </div>

    <!-- Key metrics -->
    <div class="stats-grid">
      <div class="stat-card green">
        <div class="label">MRR</div>
        <div class="value">$${mrr}</div>
        <div class="sub">${activeUsers} active × $1</div>
      </div>
      <div class="stat-card">
        <div class="label">Members</div>
        <div class="value">${activeUsers}</div>
        <div class="sub">${totalUsers} total signups</div>
      </div>
      <div class="stat-card">
        <div class="label">Searches Today</div>
        <div class="value">${searchesToday}</div>
        <div class="sub">${totalSearches} all time</div>
      </div>
      <div class="stat-card">
        <div class="label">Net Rev/Search</div>
        <div class="value">${netRevPerSearch === '—' ? '—' : '$' + netRevPerSearch}</div>
        <div class="sub">vs Google ~$0.05</div>
      </div>
      <div class="stat-card">
        <div class="label">Payments</div>
        <div class="value">${totalPayments}</div>
        <div class="sub">Stripe confirmed</div>
      </div>
      ${analytics?.totals?.stripe_charges ? `
      <div class="stat-card">
        <div class="label">Stripe Revenue</div>
        <div class="value">$${analytics.totals.stripe_revenue || 0}</div>
        <div class="sub">${analytics.totals.stripe_charges} charges</div>
      </div>` : ''}
    </div>

    <!-- Search volume chart -->
    <div class="section">
      <h2>Searches (Last 30 Days)</h2>
      ${searchDays.length > 0 ? `
        <div class="chart">
          ${searchDays.map(d => `
            <div class="chart-bar" style="height:${Math.max(2, (d.count / maxSearches) * 100)}%">
              <div class="tooltip">${d.day}: ${d.count} searches</div>
            </div>
          `).join('')}
        </div>
        <div class="chart-labels">
          <span>${searchDays[0]?.day || ''}</span>
          <span>${searchDays[searchDays.length - 1]?.day || ''}</span>
        </div>
      ` : '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">No search data available yet</div>'}
    </div>

    <!-- Signups chart -->
    <div class="section">
      <h2>Signups (Last 30 Days)</h2>
      ${signupDays.length > 0 ? `
        <div class="chart">
          ${signupDays.map(d => {
            const max = Math.max(...signupDays.map(s => s.count), 1);
            return `<div class="chart-bar" style="height:${Math.max(2, (d.count / max) * 100)}%;background:var(--yellow)">
              <div class="tooltip">${d.day}: ${d.count} signups</div>
            </div>`;
          }).join('')}
        </div>
        <div class="chart-labels">
          <span>${signupDays[0]?.day || ''}</span>
          <span>${signupDays[signupDays.length - 1]?.day || ''}</span>
        </div>
      ` : '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">No signup data yet</div>'}
    </div>

    <!-- Domain interest -->
    ${analytics?.domain_interest?.total > 0 ? `
    <div class="section">
      <h2>Domain Interest</h2>
      <div style="font-size:14px;margin-bottom:12px;">${analytics.domain_interest.total} total expressions of interest</div>
      ${(analytics.domain_interest.top || []).map(d => `
        <div class="user-row">
          <span style="color:var(--green)">${d.domain}</span>
          <span style="color:var(--gray)">${d.count} interested</span>
        </div>
      `).join('')}
    </div>
    ` : ''}

    <!-- Users -->
    <div class="section">
      <h2>Members (${userList.length})</h2>
      ${userList.length > 0 ? userList.slice(0, 50).map(u => `
        <div class="user-row">
          <div>
            <span style="color:#e0e0e0">${u.email || '—'}</span>
            <span class="tier-badge ${u.tier === 'active' ? 'active' : 'free'}">${u.tier || 'free'}</span>
          </div>
          <span style="color:var(--muted);font-size:11px">${u.referral_code || ''}</span>
        </div>
      `).join('') : '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">No users found</div>'}
    </div>
  `;
}

// ── Enter to submit auth ──
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('authKey')) doLogin();
});

// ── Start ──
init();
</script>
</body>
</html>
